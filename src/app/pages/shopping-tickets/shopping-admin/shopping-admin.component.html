<app-side-menu />
<div class="pt-5 mt-5">
<h4 class="text-center">
     REQUISICIONES DE COMPRA
</h4>
<p>&nbsp;</p>
<div class="row m-3">
    <div class="col-auto" *ngIf="facturasPendientes.length == 0"> <p>&nbsp;</p> <button class="btn bg-p-b p-2" (click)="abrirModal()">
    <i class='bx bx-plus-circle bx-sm'></i>&nbsp;AGREGAR
</button>
</div>
    <div class="col-auto"> <p>&nbsp;</p> <button class="btn bg-p-b p-2" (click)="abrirModalProveedores()">
    <i class='bx bx-cog bx-sm'></i>&nbsp;PROVEEDORES
</button></div>
<div class="col-auto">
    <p>FECHA INICIO</p>
    <p-calendar 
    [(ngModel)]="filtroFechaIni" 
    [iconDisplay]="'input'" 
    [showIcon]="true" 
    inputId="icondisplay" 
     dateFormat="dd/mm/yy"
     [style]="{width:'100%'}"
      [showButtonBar]="true"
        [touchUI]="true" />
</div>
<div class="col-auto">
    <p>FECHA FIN</p>
    <p-calendar 
    [(ngModel)]="filtroFechaFin" 
    [iconDisplay]="'input'" 
    [showIcon]="true" 
    inputId="icondisplay" 
     dateFormat="dd/mm/yy"
     [style]="{width:'100%'}"
      [showButtonBar]="true"
        [touchUI]="true" />
</div>

<div class="col-auto">
    <p>ESTATUS</p>
      <select class="form-select h-42" [(ngModel)]="filtroStatus">
          <option [value]="item.id" *ngFor="let item of filtrocatStatusCompra">{{item.nombre}}</option>
        </select>
</div>
<div class="col-auto">
    <p>ESTATUS PAGO</p>
       <select class="form-select h-42" [(ngModel)]="filtroStatusPago">
          <option [value]="item.id" *ngFor="let item of filtrocatStatusPago">{{item.nombre}}</option>
        </select>
</div>

<div class="col-auto">
    <p>TIPO COMPRA</p>
    <select class="form-select h-42" [(ngModel)]="filtroTipo">
    <option *ngFor="let item of filtrocatTipoCompra" [value]="item.id">{{item.nombre}}</option>
    </select>
 </div>

 <div class="col-auto" *ngIf="usuario.id == idAdmin">
    <p>REGIÓN</p>
    <select class="form-select h-42" [(ngModel)]="filtroRegion">
       <option value="-1">TODO</option>
        <option value="CDMX">CDMX</option>
       <option value="QRO">QRO</option>
     </select>
                            </div> 
 <div class="col-auto" *ngIf="usuario.id == idAdmin">
                                <p>SUCURSAL / AREA</p>
                                <p-dropdown [options]="sucursales" [(ngModel)]="filtroSucursal" name="sucursal" optionLabel="nombre" [filter]="true"
                                filterBy="nombre" [showClear]="true" placeholder="SELECCIONAR SUCURSAL"
                                [style]="{width:'100%'}">
                                <ng-template pTemplate="selectedItem" let-selectedOption>
                                    <div class="flex align-items-center gap-2">
                                        <div>{{ selectedOption.nombre }}</div>
                                    </div>
                                </ng-template>
                                <ng-template let-dep pTemplate="item">
                                    <div class="flex align-items-center gap-2">
                                        <div>{{ dep.nombre }}</div>
                                    </div>
                                </ng-template>
                                </p-dropdown>
</div>

 <div class="col-auto"> <p>&nbsp;</p> <button class="btn btn-warning p-2" (click)="obtenerComprasFiltro()">
    <i class='bx bx-search bx-sm'></i>&nbsp;BUSCAR
</button>
</div>

 <div class="col-md-2"><p>&nbsp;</p>
        <button class="btn btn-success" [disabled]="regcompras.length == 0" (click)="exportToExcel(regcompras)"><img width="26" height="26" src="https://img.icons8.com/fluency/40/microsoft-excel-2019.png" alt="microsoft-excel-2019"/>&nbsp;EXCEL</button>
</div>

</div>

  
<div class="p-3 shadow m-3 bg-white" *ngIf="facturasPendientes.length>0">
 <p-messages 
    [(value)]="messages" 
    [enableService]="false" 
    [closable]="false" />
 <p-table [value]="facturasPendientes" [tableStyle]="{ 'min-width': '50rem' }">
    <ng-template pTemplate="header">
        <tr>
            <th>SOLICITANTE</th>
            <th>FECHA</th>
            <th>REGION</th>
            <th>RAZON SOCIAL</th>
            <th>PROVEEDOR</th>
            <th>SUCURSAL / AREA</th>
            <th>MÉTODO PAGO</th>
            <th>ARTÍCULOS</th>
            <th>ESTATUS</th>
            <th>ESTATUS PAGO</th>
            <th>FECHA DE PAGO</th>
            <th>FECHA ENTREGA</th>
            <th>PALABRA CLAVE</th>
            <th>TOTAL</th>
            <th>FACTURA</th>
            <th>COMPROBANTE PAGO</th>
            <th></th>
            <th></th>
        </tr>
    </ng-template>
    <ng-template pTemplate="body" let-item>
        <tr class="bg-opacity-25" [ngClass]="{'bg-warning':(item.statuscompra == 0 || item.statuspago == 1), 'bg-success': item.statuspago == 2, 'bg-danger': item.statuscompra == 0}">
            <td>{{item.solicitante}}</td>
            <td>{{  obtenerFecha(item.fecha) | date}}</td>
            <td>{{ item.region }}</td>
            <td>{{ item.razonsocial }}</td>
            <td>{{ obtenerNombreArea(item.idArea) }}</td>
            <td>{{ obtenerNombreSucursal(item.sucursales)}}</td>
            <td>{{obtenerNombreMetodoPago(item.metodoPago)}}</td>
            <td>{{obtenerNombreArticulos(item.articulos)}}</td>
            <td>{{ obtenerNombreEstatus(item.statuscompra) }}</td>
            <td>
                <i class='bx bx-x-circle bx-sm text-danger' *ngIf="item.statuspago == 1"></i>
                <i class='bx bx-check-circle bx-sm text-success' *ngIf="item.statuspago == 2"></i>
                </td>
                <!-- {{ obtenerNombreEstatusPago(item.statuspago) }} -->
            <td><span *ngIf="item.fechadepago != null">{{obtenerFecha(item.fechadepago) | date }}</span></td>
            <td><span *ngIf="item.fechaEntrega != null"> {{ obtenerFecha(item.fechaEntrega) | date}} </span></td>
            <td>{{ item.palabraclave }}</td>
            <td>${{obtenerTotalCompras(item.articulos)| number:'1.0-2'}}</td>
            <td>
                <div class="d-flex gap-1 justify-content-center">
                    <button class="btn btn-warning" [disabled]="item.metodoPago == '1'" (click)="abrirModalDocumento(item,1)" *ngIf="item.statuspago != 2 && item.statuscompra > 0 || item.factura ==''"><i class='bx bx-cloud-upload bx-sm' ></i></button>&nbsp; 
                  <button class="btn btn-secondary" *ngIf="item.factura != ''" (click)="downloadPdfDirect(item.factura)"><i class='bx bxs-file-pdf bx-sm'></i></button>
                </div>
            </td> 
            <td>
                <div class="d-flex gap-1 justify-content-center">
                    <button class="btn btn-warning" (click)="abrirModalDocumento(item,2)" *ngIf="item.statuspago == 2 && usuario.id == idAdmin"><i class='bx bx-cloud-upload bx-sm' ></i></button>&nbsp; 
                  <button class="btn btn-secondary" *ngIf="item.comprobantePago != ''" (click)="downloadPdfDirect(item.comprobantePago)"><i class='bx bxs-file-pdf bx-sm'></i></button>
                </div>
            </td>
            <td><button class="btn btn-primary btn-notification" style="margin: 2px" >
          <i class="bx bx-message-square-dots bx-sm" style="color: rgb(255, 255, 255)" pTooltip="CHAT"  [ngClass]="{'has-notification': verificarChatNoLeido(item)}"
            tooltipPosition="top" (click)="abrirModalChat(item)"></i>
        </button></td>
            <td><button class="btn bg-p-b" pTooltip="DETALLES"  (click)="abrirModalDetalles(item)"><i class='bx bx-show bx-sm' ></i></button></td>
        </tr>
    </ng-template>
</p-table>

</div>


<div class="p-3 shadow m-3 bg-white">

    <div class="d-flex justify-content-center p-3" *ngIf="regcompras.length>0">
        <div class="w-100"><app-grafica-admin-compras [sucursales]="sucursales" [registros]="regcompras" [catAreas]="catareas" [idAdmin]="idAdmin"></app-grafica-admin-compras></div>
    </div>

 <p-table [value]="regcompras" [tableStyle]="{'min-width': '60rem', 'padding':'10px'}" [scrollable]="true" scrollHeight="700px"
        styleClass="p-datatable-gridlines" 
        [paginator]="true"
        [rows]="100">
    <ng-template pTemplate="header">
        <tr>
            <th>SOLICITANTE</th>
            <th>FECHA</th>
            <th>REGION</th>
            <th>RAZON SOCIAL</th>
            <th>PROVEEDOR</th>
            <th>SUCURSAL / AREA</th>
            <th>MÉTODO PAGO</th>
            <th>ARTÍCULOS</th>
            <th>ESTATUS</th>
            <th>ESTATUS PAGO</th>
            <th>FECHA DE PAGO</th>
            <th>FECHA ENTREGA</th>
            <th>PALABRA CLAVE</th>
            <th>TOTAL</th>
            <th>FACTURA</th>
            <th>COMPROBANTE PAGO</th>
            <th></th>
            <th></th>
        </tr>
    </ng-template>
    <ng-template pTemplate="body" let-item>
        <tr class="bg-opacity-25" [ngClass]="{'bg-warning':(item.statuscompra == 0 || item.statuspago == 1), 'bg-success': item.statuspago == 2, 'bg-danger': item.statuscompra == 0}">
            <td>{{item.solicitante}}</td>
            <td>{{  obtenerFecha(item.fecha) | date}}</td>
            <td>{{ item.region }}</td>
            <td>{{ item.razonsocial }}</td>
            <td>{{ obtenerNombreArea(item.idArea) }}</td>
            <td>{{ obtenerNombreSucursal(item.sucursales )}}</td>
            <td>{{obtenerNombreMetodoPago(item.metodoPago)}}</td>
            <td>{{obtenerNombreArticulos(item.articulos)}}</td>
            <td>{{ obtenerNombreEstatus(item.statuscompra) }}</td>
            <td>
                <i class='bx bx-x-circle bx-sm text-danger' *ngIf="item.statuspago == 1"></i>
                <i class='bx bx-check-circle bx-sm text-success' *ngIf="item.statuspago == 2"></i>
                </td>
                <!-- {{ obtenerNombreEstatusPago(item.statuspago) }} -->
            <td><span *ngIf="item.fechadepago != null">{{obtenerFecha(item.fechadepago) | date }}</span></td>
            <td><span *ngIf="item.fechaEntrega != null"> {{ obtenerFecha(item.fechaEntrega) | date}} </span></td>
            <td>{{ item.palabraclave }}</td>
            <td>${{obtenerTotalCompras(item.articulos)| number:'1.0-2'}}</td>
            <td>
                <div class="d-flex gap-1 justify-content-center">
                    <button class="btn btn-warning" [disabled]="item.metodoPago == '1'" (click)="abrirModalDocumento(item,1)" *ngIf="item.statuspago != 2 && item.statuscompra > 0 || item.factura ==''"><i class='bx bx-cloud-upload bx-sm' ></i></button>&nbsp; 
                  <button class="btn btn-secondary" *ngIf="item.factura != ''" (click)="downloadPdfDirect(item.factura)"><i class='bx bxs-file-pdf bx-sm'></i></button>
                </div>
            </td> 
            <td>
                <div class="d-flex gap-1 justify-content-center">
                    <button class="btn btn-warning" (click)="abrirModalDocumento(item,2)" *ngIf="item.statuspago == 2 && usuario.id == idAdmin"><i class='bx bx-cloud-upload bx-sm' ></i></button>&nbsp; 
                  <button class="btn btn-secondary" *ngIf="item.comprobantePago != ''" (click)="downloadPdfDirect(item.comprobantePago)"><i class='bx bxs-file-pdf bx-sm'></i></button>
                </div>
            </td>
            <td><button class="btn btn-primary btn-notification" style="margin: 2px" >
          <i class="bx bx-message-square-dots bx-sm" style="color: rgb(255, 255, 255)" pTooltip="CHAT"  [ngClass]="{'has-notification': verificarChatNoLeido(item)}"
            tooltipPosition="top" (click)="abrirModalChat(item)"></i>
        </button></td>
            <td><button class="btn bg-p-b" pTooltip="DETALLES"  (click)="abrirModalDetalles(item)"><i class='bx bx-show bx-sm' ></i></button></td>
        </tr>
    </ng-template>
</p-table>
</div>

</div>

<app-agregar-compra *ngIf="visible" (closeEvent)="visible = false" [visible]="visible" [catTipoCompra]="catTipoCompra" 
[catProveedores]="catProveedores" [sucursales]="sucursales" [idAdmin]="idAdmin" [catMetodosPago]="catMetodosPago"></app-agregar-compra>

<app-proveedores *ngIf="modalProveedores" [visible]="modalProveedores" (closeEvent)="modalProveedores = false"></app-proveedores>

<app-subir-documento *ngIf="modalFactura" [visible]="modalFactura" (closeEvent)="modalFactura = false"
 [Reg]="itemReg" [tipoDoc]="tipoDoc"></app-subir-documento>

<app-archivos *ngIf="modalArchivos && itemReg != undefined" [visible]="modalArchivos" 
(closeEvent)="modalArchivos = false" [factura]="itemReg!.factura"></app-archivos>

<app-detalles *ngIf="modalDetalles" [visible]="modalDetalles" [itemReg]="itemReg" [catStatus]="catStatusCompra" [catStatusPago]="catStatusPago"
(closeEvent)="modalDetalles = false" [idAdmin]="idAdmin" [catMetodosPago]="catMetodosPago" [sucursales]="sucursales" [catProveedores]="catProveedores"></app-detalles>

<app-admin-compras-chat *ngIf="modalChat" [showModalChatCompra]="modalChat" [ticket]="itemReg"
  (closeEvent)="modalChat = false"></app-admin-compras-chat>
